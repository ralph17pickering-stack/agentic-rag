# RAG-Fusion Implementation

✅ **Simple** — Single-pass executable, minimal scope (2 edits + 1 new file, no DB/frontend changes)

## Context

The app already has hybrid search (semantic + keyword merged via RRF for a **single query**). RAG-Fusion diversifies on the **query side**: an LLM generates N alternative phrasings of the user's question, retrieval runs for each independently (in parallel), and all result lists are merged via RRF. This improves recall for ambiguous or multi-faceted questions. The existing `reciprocal_rank_fusion()` already accepts N lists — no DB changes needed.

## Files to Change

| File | Action |
|---|---|
| `backend/app/config.py` | Add 2 config flags |
| `backend/app/services/query_expansion.py` | **Create** — sub-query generation |
| `backend/app/services/retrieval.py` | Refactor `retrieve_chunks` |
| `.agent/plans/11.rag-fusion.md` | Save plan copy per project convention |

## Step-by-Step Plan

### 1. `backend/app/config.py` — Add flags

Add after the `retrieval_candidates` line:

```python
rag_fusion_enabled: bool = False      # set RAG_FUSION_ENABLED=true in .env to activate
rag_fusion_query_count: int = 3       # additional sub-queries; total = 1 + this value
```

### 2. Create `backend/app/services/query_expansion.py`

Follows the exact pattern of `reranker.py`: import `client` from `llm.py`, Pydantic model, `json_object` response format, `@traceable`, exception fallback.

### 3. `backend/app/services/retrieval.py` — Refactor `retrieve_chunks`

- Build `all_queries` list (original + sub-queries if fusion enabled)
- Extract per-query retrieval into an inner `_retrieve_one` async closure
- `asyncio.gather` over all queries in parallel
- If >1 result list: pass all to existing `reciprocal_rank_fusion()`
- If 1 result list: skip the extra RRF pass (zero overhead when disabled)
- Reranking unchanged: uses original `query` string, runs on final fused results

## Verification

**Enable and test via `.env`:**
```
RAG_FUSION_ENABLED=true
RAG_FUSION_QUERY_COUNT=3
```
Restart the backend, then ask a multi-faceted question in the chat UI.

**Check LangSmith trace:**
- Should show a `generate_sub_queries` span with 3 sub-queries
- Should show 4 parallel retrieval spans
- Final `rerank_chunks` span using the original query

**Regression (fusion disabled):**
- With `RAG_FUSION_ENABLED=false` (default), behavior and latency identical to pre-change.
- LangSmith trace shows no `generate_sub_queries` span.
