# Plan: GraphRAG Functionality
**Status: Completed**

ðŸ”´ **Complex** â€” Executed as 3 sequential sub-plans.

## What Was Built

Microsoft-style GraphRAG added to the existing hybrid+rerank RAG pipeline.

### Sub-Plan A: Entity/Relationship Extraction (14.a)
- **Migration `014_graphrag_schema.sql`**: `entities`, `relationships`, `chunk_entities` tables + RLS + RPCs (`upsert_entity`, `upsert_relationship`, `get_entity_neighbor_chunks`, `get_entities_for_chunks`, `find_entity_path`)
- **`backend/app/services/graph_extractor.py`**: LLM-batched extraction (Pydantic models, graceful fallback), upsert helpers, `extract_graph_for_document()` entry point
- **`backend/app/config.py`**: 9 new `graphrag_*` settings
- **`backend/app/services/ingestion.py`**: graph extraction + community rebuild called after chunk insert
- **`backend/app/routers/documents.py`**: `POST /api/documents/backfill-graph` endpoint

### Sub-Plan B: Community Detection (14.b)
- **Migration `015_graphrag_communities.sql`**: `communities` table + RLS + `get_user_communities`, `get_communities_for_entities` RPCs
- **`backend/app/services/community_builder.py`**: NetworkX `greedy_modularity_communities`, LLM summarization per community, delete+reinsert pipeline
- **`backend/requirements.txt`**: `networkx>=3.3`
- **`backend/app/main.py`**: `_community_rebuild_loop` (24h periodic)

### Sub-Plan C: Retrieval Integration (14.c)
- **`backend/app/services/graph_retrieval.py`**: `expand_with_entity_neighbors`, `global_graph_search`, `relationship_graph_search`
- **`backend/app/services/retrieval.py`**: entity-neighbour expansion appended after reranking
- **`backend/app/services/llm.py`**: `GRAPH_SEARCH_TOOL`, updated `get_tools()`, `_execute_tool()`, system prompt, `_format_chunks()` (`[graph-expanded]` tag)

## Bug Fixed During Validation

`ToolContext` was missing `user_id` â€” graph RPCs use `SECURITY DEFINER` with explicit `p_user_id` param, and `sb.auth.get_user()` does not work on a postgrest-auth'd client. Fixed by adding `user_id: str = ""` to `ToolContext`, passing from `chat.py`, and removing the `sb.auth.get_user()` fallback in `graph_retrieval.py`.

## Validation Results

- 10+ entities extracted, 29 relationships, 6 communities from test document
- `graph_search(mode='global')` returns LLM-summarised community themes
- `graph_search(mode='relationship')` finds paths or gracefully returns "not found"
- Ingestion completes to `ready` status regardless of graph extraction outcome
- `GRAPHRAG_ENABLED=false` disables all graph behaviour

## Config Settings

| Setting | Default |
|---|---|
| `graphrag_enabled` | `True` |
| `graphrag_extraction_batch_size` | `5` |
| `graphrag_entity_types` | `PERSON,ORGANIZATION,...` |
| `graphrag_community_min_size` | `3` |
| `graphrag_community_chunks_per_summary` | `5` |
| `graphrag_community_rebuild_enabled` | `True` |
| `graphrag_expansion_enabled` | `True` |
| `graphrag_expansion_top_k` | `3` |
| `graphrag_global_communities_top_n` | `5` |
