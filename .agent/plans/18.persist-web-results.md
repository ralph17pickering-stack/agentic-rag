# Plan: Persist Web Results per Thread

⚠️ **Medium** — touches migration, backend model, chat router, frontend types, and useChat hook.

## Goal

Save web search results with the assistant message that triggered them, and restore them when a thread is reopened. Covers PROGRESS.md items:
- "Persist web results per thread (storage)" — model + DB/API
- "Persist web results per thread (UI)" — restore saved links in the right panel

---

## Tasks

### 1. DB Migration — add `web_results` column to messages

**File:** `supabase/migrations/016_web_results_on_messages.sql`

```sql
ALTER TABLE messages
  ADD COLUMN IF NOT EXISTS web_results JSONB DEFAULT NULL;
```

No index needed — only reading by thread/message, not querying the JSONB.

**Validation:** `SELECT column_name FROM information_schema.columns WHERE table_name='messages' AND column_name='web_results';` returns one row.

---

### 2. Backend — update MessageResponse model

**File:** `backend/app/models/messages.py`

Add optional field:
```python
from typing import Any, Optional
web_results: Optional[list[dict[str, Any]]] = None
```

**Validation:** `GET /api/threads/{id}/messages` returns JSON with `web_results` key on each message (null for old messages).

---

### 3. Backend — capture web results in chat router, persist with message

**File:** `backend/app/routers/chat.py`

In `event_generator()`:
- Add `accumulated_web_results: list = []` before the stream loop
- When a `web_search` ToolEvent is received, append `event.data.get("results", [])` to `accumulated_web_results`
- When inserting the assistant message, include `"web_results": accumulated_web_results or None`

```python
accumulated_web_results: list = []

async for event in stream_chat_completion(...):
    if isinstance(event, ToolEvent) and event.tool_name == "web_search":
        results = event.data.get("results", [])
        accumulated_web_results.extend(results)   # support multiple web searches
        yield {"data": json.dumps({"web_results": results})}
    ...

# Save assistant message
sb.table("messages").insert({
    ...
    "web_results": accumulated_web_results if accumulated_web_results else None,
}).execute()
```

**Validation:** After a chat with web search, query the DB:
```sql
SELECT web_results FROM messages WHERE role='assistant' ORDER BY created_at DESC LIMIT 1;
```
Should return a non-null JSONB array.

---

### 4. Frontend — update Message type

**File:** `frontend/src/types/index.ts`

Add optional field to `Message`:
```typescript
web_results?: WebResult[] | null
```

**Validation:** TypeScript compiles without errors.

---

### 5. Frontend — restore web results in useChat on thread load

**File:** `frontend/src/hooks/useChat.ts`

In `fetchMessages`, after setting messages, find the last assistant message with non-null `web_results` and call `setWebResults`:

```typescript
const fetchMessages = useCallback(async (tid: string) => {
  setLoading(true)
  try {
    const res = await apiFetch(`/api/threads/${tid}/messages`)
    if (res.ok) {
      const data: Message[] = await res.json()
      setMessages(data)
      // Restore web results from last assistant message that has them
      const lastWithResults = [...data].reverse().find(
        m => m.role === "assistant" && m.web_results && m.web_results.length > 0
      )
      setWebResults(lastWithResults?.web_results ?? [])
    }
  } finally {
    setLoading(false)
  }
}, [])
```

**Validation:** Switch to a thread that previously had a web search — the right panel should show the saved web results.

---

### 6. Apply migration

Run:
```bash
docker exec -i supabase-db psql -U postgres -d postgres -f - < supabase/migrations/016_web_results_on_messages.sql
```

---

## Execution Order

1. Write migration file
2. Apply migration
3. Update backend MessageResponse model
4. Update chat router
5. Update frontend Message type
6. Update useChat fetchMessages
7. Typecheck frontend
8. Browser test: send a web-search query, switch threads, return — results should reappear

---

## Gotchas

- The migration uses `IF NOT EXISTS` so it's safe to re-run
- `accumulated_web_results` should use `.extend()` (not append) since results is already a list
- The `done` SSE event sends `data.message` — that message object now has `web_results` included, so the in-flight message should also reflect it (the frontend sets it via `setMessages(prev => [...prev, data.message])`)
- Don't clear `webResults` on thread switch before `fetchMessages` resolves — this could cause a flash. The current code clears on `sendMessage` which is fine. On `fetchMessages` completion, we overwrite with restored results (or empty).
