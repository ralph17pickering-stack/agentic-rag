# Plan: Periodic Topic Consolidation

**Status: Completed**

⚠️ **Medium** - Background task + LLM call + DB updates, low blast radius

## Context
LLM-extracted topic tags can drift semantically over time — e.g. "developer tools" vs "development tools", "ml" vs "machine learning". These appear as separate filter badges in the UI even though they represent the same concept. A periodic background process detects near-duplicate topics and unifies them to a canonical form, updating all affected documents in place.

## Approach
- `topic_consolidator.py` service fetches all unique topics per user, asks the LLM to group near-synonyms, then updates each document's topics array with the canonical names.
- Consolidation runs per-user (preserves data isolation) using the service role client (bypasses RLS for global traversal while retaining `user_id` ownership).
- A background asyncio loop is started in `main.py` `lifespan`, sleeping for the configured interval before each run. First run waits the full interval (avoids hammering LLM on every restart).
- Feature-flagged with `topic_consolidation_enabled` (default `True`).

## Files Modified

### `app/backapp/frontend/app/config.py`
Added:
- `topic_consolidation_enabled: bool = True`
- `topic_consolidation_interval_hours: int = 24`

### `app/backapp/frontend/app/services/topic_consolidator.py` *(new)*
- `TopicMappings` Pydantic model: `{mappings: dict[str, str]}`
- `get_topic_mappings(topics)` — LLM call returning `{old: canonical}` dict
- `consolidate_topics_for_user(user_id)` — fetches docs, applies mappings, updates DB
- `consolidate_all_users()` — iterates all distinct user IDs in documents table

### `app/backapp/frontend/app/main.py`
- `_topic_consolidation_loop()` — sleeps interval, then runs `consolidate_all_users()`
- Registered via `asyncio.create_task()` in `lifespan` when `topic_consolidation_enabled=True`

## Testing
- Set `TOPIC_CONSOLIDATION_INTERVAL_HOURS=0.001` (~3 seconds) for quick testing
- Watch for "Running periodic topic consolidation" in backend logs
- Set `TOPIC_CONSOLIDATION_ENABLED=false` to disable
