# Module 8: Lean Sub-Agent (Deep Analysis)

**Complexity:** ⚠️ Medium — additive feature, follows existing tool patterns, 1 new file + 6 edits

**Status:** ✅ Completed

## Overview

A sub-agent that does multi-pass document retrieval for thorough analysis. The LLM decides when to use it (same way it picks `web_search` vs `retrieve_documents`), keeping the implementation simple and consistent.

## Changes Made

### 1. Config flag
**File:** `app/backapp/frontend/app/config.py`
- Added `sub_agents_enabled: bool = True`

### 2. Sub-agent service (new file)
**File:** `app/backapp/frontend/app/services/sub_agent.py`

`run_sub_agent(query, retrieve_fn, user_token, focus_areas, on_status) -> str`

- Focused system prompt: "You are a thorough document analyst" — instructs multi-pass retrieval + synthesis
- Own tool loop (up to 5 rounds) — only has `retrieve_documents` and `query_documents_metadata` (no web_search, no recursion)
- `on_status` callback: async callable invoked at milestones ("Analyzing documents...", "Retrieving more context...", "Synthesizing findings...")
- Text tool call parsing for local LLM compatibility (duplicated from llm.py with allowlist filter)
- `@traceable` decorated for LangSmith
- Reuses `_format_chunks` from llm.py, `execute_metadata_query` from sql_tool.py

### 3. Tool definition + dispatch in LLM service
**File:** `app/backapp/frontend/app/services/llm.py`

- Added `DEEP_ANALYSIS_TOOL` definition: `deep_analysis(query, focus_areas?)`
- Updated `SYSTEM_PROMPT_WITH_TOOLS` with tool #4 description
- Updated `get_tools()`: include when `sub_agents_enabled and has_documents`
- Updated `_execute_tool()`: added `on_status` param, handles `deep_analysis` → `run_sub_agent()`
- Updated `stream_chat_completion()`: status event collection list, yields `ToolEvent`s during execution, emits `done` event before final streaming

### 4. SSE event for sub-agent status
**File:** `app/backapp/frontend/app/routers/chat.py`

- Handles `ToolEvent(tool_name="deep_analysis")` → yields `{"sub_agent_status": event.data}`

### 5. Frontend hook state
**File:** `app/frontend/src/hooks/useChat.ts`

- Added `deepAnalysisPhase` (string | null) and `usedDeepAnalysis` (boolean) state
- Handles `data.sub_agent_status` SSE events (phase updates + done signal)
- Reset on new message send, clear phase on finally

### 6. MessageArea UI
**File:** `app/frontend/src/components/chat/MessageArea.tsx`

- Accepts `deepAnalysisPhase` and `usedDeepAnalysis` props
- "Thinking..." indicator shows `deepAnalysisPhase` when set
- Streaming message bubble shows violet "Deep Analysis" badge when `usedDeepAnalysis`

### 7. Wire props
**File:** `app/frontend/src/components/chat/ChatLayout.tsx`

- Destructures new values from `useChat`, passes to `MessageArea` (both mobile and desktop)

## Design Decisions

- **No badge persistence**: badge is ephemeral (SSE-only, not stored in DB). Persisting requires a `metadata` JSONB column — deferred.
- **Same model for sub-agent**: uses `settings.llm_model`. A separate model setting can be added later.
- **5-round limit**: higher than main agent's 3, since multi-pass retrieval is the point.
- **List-based status collection** (not asyncio.Queue): `_execute_tool` is awaited sequentially, so a plain list suffices.
- **Allowlist filter on sub-agent**: text tool call parser only accepts `retrieve_documents` and `query_documents_metadata` — prevents LLM from attempting `web_search` or `deep_analysis` recursion.
